name: Publish Filtered Hosts Release

on:
  workflow_dispatch: # 允许手动触发
  schedule:
    - cron: '0 0 * * *' # 每天UTC午夜自动运行

jobs:
  process-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Download hosts file
        run: |
          curl -sL https://raw.githubusercontent.com/lingeringsound/10007/main/all > original_hosts

      - name: Filter hosts entries
        run: |
          # 过滤掉不需要的域名
          grep -v -e 'mtalk.google.com' -e 'dl.google.com' -e 'dl.l.google.com' original_hosts > filtered_hosts
          
          # 添加文件头信息并命名为10007.txt
          echo "# Filtered hosts file" > 10007.txt
          echo "# Generated at $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> 10007.txt
          echo "# Original source: https://raw.githubusercontent.com/lingeringsound/10007/main/all" >> 10007.txt
          echo "" >> 10007.txt
          cat filtered_hosts >> 10007.txt

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: hosts
          name: "Filtered Hosts"
          body: | 
            Auto-generated filtered hosts file
            - Removed entries containing:
              - *mtalk.google.com
              - dl.google.com
              - dl.l.google.com
          files: 10007.txt  # 修改文件名
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
